#include <fstream>
#include <iostream>
#include <iomanip>
#include <cstdio>
#include <cstring>
#include <stdlib.h>
using namespace std;

class attendance
{
	char name[25];
	int att,ab,total,srno,j;
	char tempd[12],date[100][12];
public:
	void day();
	void begin();
	void getdat();
	void show();
	void save();
	void task();
	void update();
	void newm();
	void clear();
	void end();
	void caditshow();
	void name();
	attendance()
	{
		strcpy(name,"NULL");
		strcpy(tempd,"NULL");
		att=ab=total=srno=j=0;
	}
};

void attendance::day()
{
	if(strcmp(tempd,"NULL")==0)
	{
		clear();
		printf("Enter todays date (dd/mm/yy)- ");
		cin.ignore();
		cin.getline(tempd,sizeof(tempd));
	}
}

void attendance::begin()
{
	clear();
	printf("Welcome to NCS Attendance\n");
	printf("What would you like to do??\n");
	printf("1. Take Attendance\n2. See Attendance record\n");
	printf("3. Update any record\n4. Add new members!\n");
	printf("5. View specific member's attendance record. \n");
}


void attendance::getdat()
{
	
	ifstream f0("database.dat",ios::binary);
	attendance ob;
	while(!f0.eof())
		f0.read((char*)&ob,sizeof(ob));
	if(ob.srno==0)
		srno++;
	else
		srno=ob.srno+1;
	f0.close();
	cin.ignore();
	printf("Enter name of Member\n");
	cin.getline(name,sizeof(name));
	printf("Enter attendance (if present earlier/required)\n");
	cin>>att;
	cin.ignore();
}

void attendance::clear()
{
	cout <<"\033[2J\033[1;1H";
}
void attendance::save()
{
	ofstream f1("database.dat",ios::app|ios::binary);
	f1.write((char*)this,sizeof(*this));
	f1.close();
	printf("Data Saved successfully.\n");
}

void attendance::show()
{
	printf("\n\n");
	ifstream f2("database.dat",ios::binary);
	attendance ob;
	f2.read((char*)&ob,sizeof(ob));
	printf("Total Working days- %d \n",ob.total);
	cout<<left<<setw(25)<<"Sr.no NAME"<<"PRESENCE"<<" | "<<"ABSENCE"<<endl;
	while(!f2.eof())
	{
		if(ob.srno>9)
			cout<<ob.srno<<" "<<left<<setw(29)<<ob.name<<ob.att<<" | "<<ob.ab<<endl;
		else
			cout<<ob.srno<<" "<<left<<setw(30)<<ob.name<<ob.att<<" | "<<ob.ab<<endl;		
		f2.read((char*)&ob,sizeof(ob));
	}
	f2.close();
}


void attendance::task()
{
	fstream f3("database.dat",ios::binary|ios::in|ios::out);
	attendance obj;
	f3.read((char*)&obj,sizeof(obj));
	while(!f3.eof())
	{
		if(obj.srno>9)
			cout<<obj.srno<<" "<<left<<setw(29)<<obj.name<<obj.att<<" | "<<obj.ab<<endl;
		else
			cout<<obj.srno<<" "<<left<<setw(30)<<obj.name<<obj.att<<" | "<<obj.ab<<endl;
		string temp;
		getline(cin,temp);
		if(temp.empty())
			++(obj.att);
		else
		{	++(obj.ab);		strcpy(obj.date[obj.j],tempd);	obj.j++;	}
		obj.total++;
		f3.seekp(f3.tellp()-sizeof(obj));
		f3.write((char*)&obj,sizeof(obj));
		f3.read((char*)&obj,sizeof(obj));
	}
	f3.close();
}

void attendance::update()
{
	while(1)
	{
		fstream f4("database.dat",ios::in|ios::out|ios::binary);
		attendance ob;
		int flag=1,no;
		char choice;
		show();
		cout<<"Enter the serial number of member reffering the above attendance list\n";
		cin>>no;
		f4.read((char*)&ob,sizeof(ob));
		while(!f4.eof())
		{
			if(no==ob.srno)
			{
				cout<<"\n"<<ob.srno<<" "<<left<<setw(30)<<ob.name<<ob.att<<" | "<<ob.ab<<endl;
				while(1)
				{
						printf("Were you present?? (Y/N)\n");
					cin>>choice;
					if(choice=='Y'||choice=='y')
						{	ob.att++; ob.ab--;	ob.j--;	break; }
					else if(choice=='N'||choice=='n')
						{	ob.att--; ob.ab++;	strcpy(ob.date[ob.j],tempd);	ob.j++;	break;	}
					else
						printf("Wrong choice\n");
				}
				f4.seekp(f4.tellp()-sizeof(ob));
				f4.write((char*)&ob,sizeof(ob));
				flag=0;
				break;
			}
			f4.read((char*)&ob,sizeof(ob));
		}
		if(flag)
			printf("No record found.\n");
		f4.close();
		cout<<"Want to update more records?? (Y/N)??\n";
		cin>>choice;
		if(choice=='y'||choice=='Y')
				continue;
			else if(choice=='n'||choice=='N')
				break;
			else
				{	printf("Incorrect input. Further updates aborted.\n\n"); break;	}
	}
}

void attendance::newm()
{
	while(1)
	{
		char choice;
		getdat();
		save();
		cout<<"Want to add more members?? (Y/N)\n";
		cin>>choice;
		if(choice=='y'||choice=='Y')
			continue;
		else if(choice=='n'||choice=='N')
			break;
		else
			{	cout<<"Wrong coice\n"; break; }
	}
}

void attendance::end()
{
	printf("\nThank you for using. :)\n\n");
}

void attendance::caditshow()
{
	printf("\n\n");
	int no,flag=1,count;
	attendance ob;
	ifstream f5("database.dat",ios::binary);
	show();
	printf("Enter member's serial number refering the above attendance list- ");
	cin>>no;
	f5.read((char*)&ob,sizeof(ob));
	while(!f5.eof())
	{
		if(no==ob.srno)
		{
			cout<<"\n"<<ob.srno<<" "<<left<<setw(30)<<ob.name<<ob.att<<" | "<<ob.ab<<endl;
			count=ob.j;
			cout<<"Absent dates- \n";
			while(count)
				cout<<ob.date[--count]<<endl;
			flag=0;
			break;
		}
		f5.read((char*)&ob,sizeof(ob));
	}
	if(flag)
		printf("No such member found\n");
}

void attendance::name_change()
{
	printf("\n\n");
	int no,flag=1;
	attendance ob;
	fstream f6("database.dat",ios::in|ios::out|ios::binary);
	show();
	printf("Enter member's serial number refering the above attendance list- ");
	cin>>no;
	f6.read((char*)&ob,sizeof(ob));
	while(!f6.eof())
	{
		if(no==ob.srno)
		{
			cout<<"\n"<<ob.srno<<" "<<left<<setw(30)<<"Name of member - "<<ob.name<<endl;
			printf("Enter the new name of member- ");
			cin.ignore();
			cin.getline(name,sizeof(name));
			strcpy(ob.name,name);
			f6.seekp(f6.tellp()-sizeof(ob));
			f6.write((char*)&ob,sizeof(ob));
			flag=0;
			break;
		}
	f6.read((char*)&ob,sizeof(ob));
	}
	if(flag)
		printf("No member found\n");
	else
		printf("Changes updated.\n");
}